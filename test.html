<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abracadabra API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .result {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        input[type="text"] {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-200 { color: #4caf50; font-weight: bold; }
        .status-400 { color: #ff9800; font-weight: bold; }
        .status-401 { color: #f44336; font-weight: bold; }
        .status-500 { color: #9c27b0; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üé© Abracadabra API Test</h1>

    <div class="test-section">
        <h2>Server Connection Test</h2>
        <button onclick="testConnection()">Test Server Connection</button>
        <div id="connection-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Document List API Test</h2>
        <p>Test the <code>/api/documents/</code> endpoint with different configurations:</p>

        <div>
            <label>Base URL:</label>
            <input type="text" id="baseUrl" value="http://localhost:8787" placeholder="http://localhost:8787">
        </div>

        <div>
            <label>Auth Token (optional):</label>
            <input type="text" id="authToken" placeholder="Enter session token if you have one">
        </div>

        <button onclick="testDocumentsAPI()">Test Documents API (No Auth)</button>
        <button onclick="testDocumentsAPIWithAuth()">Test Documents API (With Auth)</button>
        <button onclick="testLoginAPI()">Test Login API</button>

        <div id="api-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>WebSocket Test</h2>
        <button onclick="testWebSocket()">Test WebSocket Connection</button>
        <button onclick="closeWebSocket()">Close WebSocket</button>
        <div id="ws-result" class="result"></div>
    </div>

    <script>
        let ws = null;

        function log(elementId, message, className = '') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent = `[${timestamp}] ${message}\n` + element.textContent;
            if (className) {
                element.className = `result ${className}`;
            }
        }

        function getStatusClass(status) {
            if (status >= 200 && status < 300) return 'status-200';
            if (status >= 400 && status < 500) return 'status-400';
            if (status >= 500) return 'status-500';
            return '';
        }

        async function testConnection() {
            const baseUrl = document.getElementById('baseUrl').value;
            log('connection-result', 'Testing server connection...', '');

            try {
                const response = await fetch(baseUrl + '/', {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });

                const statusClass = getStatusClass(response.status);
                log('connection-result',
                    `‚úÖ Server is reachable!\nStatus: ${response.status} ${response.statusText}\nContent-Type: ${response.headers.get('content-type')}`,
                    'success');

            } catch (error) {
                log('connection-result', `‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function testDocumentsAPI() {
            const baseUrl = document.getElementById('baseUrl').value;
            await testAPI(baseUrl + '/api/documents/', {}, 'Documents API (No Auth)');
        }

        async function testDocumentsAPIWithAuth() {
            const baseUrl = document.getElementById('baseUrl').value;
            const token = document.getElementById('authToken').value;

            if (!token.trim()) {
                log('api-result', '‚ùå Please enter an auth token first', 'error');
                return;
            }

            const headers = { 'Authorization': `Bearer ${token}` };
            await testAPI(baseUrl + '/api/documents/', headers, 'Documents API (With Auth)');
        }

        async function testLoginAPI() {
            const baseUrl = document.getElementById('baseUrl').value;
            log('api-result', 'Testing login API...', '');

            try {
                const response = await fetch(baseUrl + '/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'demo',
                        password: 'demo123'
                    })
                });

                const text = await response.text();
                const statusClass = getStatusClass(response.status);

                let logMessage = `Login API Test\nStatus: ${response.status} ${response.statusText}\n`;
                logMessage += `Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n`;
                logMessage += `Response: ${text}`;

                if (response.ok) {
                    try {
                        const json = JSON.parse(text);
                        if (json.data && json.data.session && json.data.session.token) {
                            document.getElementById('authToken').value = json.data.session.token;
                            logMessage += '\n\n‚úÖ Token automatically filled in above field!';
                        }
                    } catch (e) {
                        // Response not JSON
                    }
                    log('api-result', logMessage, 'success');
                } else {
                    log('api-result', logMessage, 'error');
                }

            } catch (error) {
                log('api-result', `‚ùå Login API failed: ${error.message}`, 'error');
            }
        }

        async function testAPI(url, headers = {}, testName = 'API') {
            log('api-result', `Testing ${testName}...`, '');

            try {
                const finalHeaders = {
                    'Accept': 'application/json',
                    ...headers
                };

                const response = await fetch(url, {
                    method: 'GET',
                    headers: finalHeaders
                });

                const text = await response.text();
                const statusClass = getStatusClass(response.status);

                let logMessage = `${testName}\nURL: ${url}\nStatus: ${response.status} ${response.statusText}\n`;
                logMessage += `Headers Sent: ${JSON.stringify(finalHeaders, null, 2)}\n`;
                logMessage += `Response Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n`;
                logMessage += `Response Body: ${text}`;

                if (response.ok) {
                    try {
                        const json = JSON.parse(text);
                        logMessage += `\n\nParsed JSON:\n${JSON.stringify(json, null, 2)}`;
                    } catch (e) {
                        logMessage += '\n\n(Response is not valid JSON)';
                    }
                    log('api-result', logMessage, 'success');
                } else {
                    log('api-result', logMessage, 'error');
                }

            } catch (error) {
                log('api-result', `‚ùå ${testName} failed: ${error.message}`, 'error');
            }
        }

        function testWebSocket() {
            const baseUrl = document.getElementById('baseUrl').value.replace('http', 'ws');
            const wsUrl = baseUrl + '/collaborate/abracadabra-test-room';

            log('ws-result', `Connecting to WebSocket: ${wsUrl}`, '');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    log('ws-result', '‚úÖ WebSocket connected successfully!', 'success');
                };

                ws.onmessage = function(event) {
                    log('ws-result', `üì® Message received: ${event.data}`, '');
                };

                ws.onclose = function(event) {
                    log('ws-result', `üîå WebSocket closed: Code ${event.code}, Reason: ${event.reason}`, '');
                };

                ws.onerror = function(error) {
                    log('ws-result', `‚ùå WebSocket error: ${error}`, 'error');
                };

            } catch (error) {
                log('ws-result', `‚ùå Failed to create WebSocket: ${error.message}`, 'error');
            }
        }

        function closeWebSocket() {
            if (ws) {
                ws.close();
                log('ws-result', 'üîå WebSocket closed manually', '');
            } else {
                log('ws-result', '‚ÑπÔ∏è No WebSocket connection to close', '');
            }
        }

        // Auto-test connection on load
        window.addEventListener('load', function() {
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>
